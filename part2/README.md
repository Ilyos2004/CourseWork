# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—Å–∫–∏—Ö –∑–∞–Ω—è—Ç–∏–π

**–ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞, —ç—Ç–∞–ø ‚Ññ2**  
**–ê–≤—Ç–æ—Ä:** –°–∞–Ω–≥–∏–Ω–æ–≤ –ò–ª—ë—Å–¥–∂–æ–Ω

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∑–∞–¥–∞–Ω–∏—è)  
- [ER-–º–æ–¥–µ–ª—å](#ER-–º–æ–¥–µ–ª—å)  
- [–î–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å](#DDL-–º–æ–¥–µ–ª—å)  
- [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î PostgreSQL](#–†–µ–∞–ª–∏–∑–∞—Ü–∏—è-–¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π-–º–æ–¥–µ–ª–∏-–≤-—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π-–°–£–ë–î-PostgreSQL).
- [–¢—Ä–∏–≥–≥–µ—Ä—ã](#–¢—Ä–∏–≥–≥–µ—Ä—ã)  
- [–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è,—É–¥–∞–ª–µ–Ω–∏—è –ë–î,–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏](#–°–∫—Ä–∏–ø—Ç—ã-–¥–ª—è-—Å–æ–∑–¥–∞–Ω–∏—è-,-—É–¥–∞–ª–µ–Ω–∏—è-–ë–î-,-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è-–±–∞–∑—ã-—Ç–µ—Å—Ç–æ–≤—ã–º–∏-–¥–∞–Ω–Ω—ã–º–∏–µ)  
- [PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.](#PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏-–∏-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã-–¥–ª—è-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏-–≤–∞–∂–Ω—ã—Ö-–∑–∞–ø—Ä–æ—Å–æ–≤)  
- [–ò–Ω–¥–µ–∫—Å—ã](#–ò–Ω–¥–µ–∫—Å—ã)  

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è

1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å ER-–º–æ–¥–µ–ª—å (–≤ PDF/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏).  
2. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫—É—é –º–æ–¥–µ–ª—å (–º–∏–Ω–∏–º—É–º 10 —Å—É—â–Ω–æ—Å—Ç–µ–π, –µ—Å—Ç—å M:N).  
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –≤ PostgreSQL (DDL).  
4. –û–±–µ—Å–ø–µ—á–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å (DDL, —Ç—Ä–∏–≥–≥–µ—Ä—ã).  
5. –°–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ë–î –∏ seed.  
6. PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏/–ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.  
7. –°–æ–∑–¥–∞—Ç—å –∏ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã.

---

## ER-–º–æ–¥–µ–ª—å
<img alt=" " src="https://github.com/Ilyos2004/CourseWork/blob/dev2/part2/ER%20-%20%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C.png">

## DDL-–º–æ–¥–µ–ª—å
<img alt=" " src="https://github.com/Ilyos2004/CourseWork/blob/dev2/part2/DDL%20-%20%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C.png">

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î PostgreSQL


```sql
-- 1. Role
CREATE TABLE roles (
  role_id SERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE
);

-- 2. User
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  full_name TEXT NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  phone TEXT,
  role_id INT NOT NULL REFERENCES roles(role_id)
);

-- 3. Tutor_Profiles
CREATE TABLE tutor_profiles (
  id SERIAL PRIMARY KEY,
  experience_years INT DEFAULT 0 CHECK (experience_years >= 0),
  info TEXT,
  rating_count INT DEFAULT 0 CHECK (rating_count >= 0),
  languages TEXT,
  user_id INT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE
);

-- 4. Student_Profiles
CREATE TABLE student_profiles (
  id SERIAL PRIMARY KEY,
  preferred_language VARCHAR(100),
  goals TEXT,
  age INT,
  user_id INT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE
);

-- 5. Subjects
CREATE TABLE subjects (
  id SERIAL PRIMARY KEY,
  name VARCHAR(150) NOT NULL UNIQUE
);

-- 6. Tutor_Subjects
CREATE TABLE tutor_subjects (
  id SERIAL PRIMARY KEY,
  subject_id INT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  tutor_id INT NOT NULL REFERENCES tutor_profiles(id) ON DELETE CASCADE,
  info TEXT,
  count_students INT DEFAULT 0 CHECK (count_students >= 0),
  languages VARCHAR(150)
);

-- 7. Format
CREATE TABLE format (
  id SERIAL PRIMARY KEY,
  type TEXT NOT NULL UNIQUE
);

-- 8. Location
CREATE TABLE location (
  id SERIAL PRIMARY KEY,
  format_id INT REFERENCES format(id),
  info TEXT
);

-- 9. Time_Slot
CREATE TABLE time_slot (
  id SERIAL PRIMARY KEY,
  tutor_id INT NOT NULL REFERENCES tutor_profiles(id) ON DELETE CASCADE,
  subject_id INT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  location_id INT REFERENCES location(id),
  start_dt TEXT NOT NULL,
  end_dt TEXT NOT NULL,
  capacity INT NOT NULL DEFAULT 1 CHECK (capacity > 0),
  status TEXT
);

-- 10. Booking
CREATE TABLE booking (
  id SERIAL PRIMARY KEY,
  slot_id INT NOT NULL REFERENCES time_slot(id) ON DELETE CASCADE,
  student_id INT NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
  booked_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  status TEXT
);

-- 11. Review
CREATE TABLE review (
  id SERIAL PRIMARY KEY,
  student_id INT NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
  tutorsubject_id INT REFERENCES tutor_subjects(id) ON DELETE SET NULL,
  rating INT CHECK (rating BETWEEN 1 AND 5),
  comment TEXT
);
```
## –¢—Ä–∏–≥–≥–µ—Ä—ã

#### 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –Ω–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –Ω–∞—á–∞–ª—Å—è

```sql
CREATE OR REPLACE FUNCTION check_booking_before_start()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  s timestamptz;
BEGIN
  -- —è–≤–Ω–æ –ø—Ä–∏–≤–æ–¥–∏–º TEXT -> timestamptz (—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤ ISO)
  SELECT start_dt::timestamptz INTO s
  FROM time_slot
  WHERE id = NEW.slot_id
  LIMIT 1;

  IF s IS NULL THEN
    RAISE EXCEPTION 'Slot % not found (booking before start check)', NEW.slot_id;
  END IF;

  IF s <= now() THEN
    RAISE EXCEPTION 'Cannot book slot %: it already started at %', NEW.slot_id, s;
  END IF;

  RETURN NEW;
END;
$$;
```
#### 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (capacity) –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –±—Ä–æ–Ω–∏
```sql
CREATE OR REPLACE FUNCTION fn_check_capacity()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  cap INT;
  cnt INT;
BEGIN
  -- –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å—á–∏—Ç–∞–µ—Ç—Å—è "booked"
  IF NOT (NEW.status IS NULL OR lower(NEW.status) = 'booked') THEN
    RETURN NEW;
  END IF;

  -- –µ—Å–ª–∏ —ç—Ç–æ UPDATE –∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ –±—ã–ª 'booked' ‚Äî –Ω–µ—Ç —Ä–æ—Å—Ç–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ -> –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
  IF TG_OP = 'UPDATE' AND (OLD.status IS NOT NULL AND lower(OLD.status) = 'booked') THEN
    RETURN NEW;
  END IF;

  -- –±–ª–æ–∫–∏—Ä—É–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É time_slot –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
  SELECT capacity INTO cap FROM time_slot WHERE id = NEW.slot_id FOR UPDATE;
  IF cap IS NULL THEN
    RAISE EXCEPTION 'Slot % not found (capacity check)', NEW.slot_id;
  END IF;

  SELECT count(*) INTO cnt FROM booking
    WHERE slot_id = NEW.slot_id AND (status IS NULL OR lower(status) = 'booked');

  IF cnt >= cap THEN
    RAISE EXCEPTION 'Cannot book slot %: capacity % already reached', NEW.slot_id, cap;
  END IF;

  RETURN NEW;
END;
$$;
```

#### 3Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–ª–æ—Ç–∞
```sql
-- –§—É–Ω–∫—Ü–∏—è: –∞–≤—Ç–æ-–æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ —Å–ª–æ—Ç–∞ –≤ status = 'cancelled'
CREATE OR REPLACE FUNCTION fn_auto_cancel_bookings_on_slot_cancel()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  IF TG_OP = 'UPDATE' AND OLD.status IS DISTINCT FROM NEW.status
     AND NEW.status IS NOT NULL AND lower(NEW.status) = 'cancelled' THEN

    UPDATE booking
    SET status = 'cancelled', updated_at = now()
    WHERE slot_id = NEW.id
      AND (status IS NULL OR lower(status) <> 'cancelled');
  END IF;

  RETURN NEW;
END;
$$;
```
## –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è –ë–î, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

#### üèóÔ∏è –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ë–î
```sql
CREATE DATABASE rehearsal_classes;
```
#### üóëÔ∏è–°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ë–î
```sql
DROP DATABASE rehearsal_classes;
```
#### –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
INSERT INTO roles (name) VALUES
  ('student'),
  ('tutor'),
  ('admin');

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
INSERT INTO "user" (full_name, email, password, phone, role_id)
VALUES
  ('Ivan Ivanov', 'ivan@student.example', 'pwd_hash_ivan', '+7-900-000-0001', 1),
  ('Petr Petrov', 'petr@tutor.example', 'pwd_hash_petr', '+7-900-000-0002', 1),
  ('Anna Annanovna', 'anna@tutor.example', 'pwd_hash_anna', '+7-900-000-0003', 2),
  ('Admin User', 'admin@example', 'pwd_hash_admin', '+7-900-000-0000', 3);

-- –ü—Ä–æ—Ñ–∏–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
INSERT INTO student_profiles (preferred_language, goals, age, user_id)
VALUES
  ('ru', '–ü–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ', 20, 2),
  ('ru', '–†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠', 17, 6);

-- –ü—Ä–µ–¥–º–µ—Ç—ã
INSERT INTO subjects (name) VALUES
  ('Mathematics'),
  ('Physics'),
  ('English');

-- –†–µ–ø–µ—Ç–∏—Ç–æ—Ä—ã –∏ –∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ã
INSERT INTO tutor_subjects (subject_id, tutor_id, info, count_students, languages)
VALUES
  (1, 1, '–ê–ª–≥–µ–±—Ä–∞, –∞–Ω–∞–ª–∏–∑, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠', 0, 'ru'),
  (2, 2, 'Physics, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠', 15, 'ru,en');

-- –§–æ—Ä–º–∞—Ç—ã –∑–∞–Ω—è—Ç–∏–π
INSERT INTO format (type)
VALUES
  ('online'),
  ('offline');

-- –õ–æ–∫–∞—Ü–∏–∏
INSERT INTO location (format_id, info)
VALUES
  ((SELECT id FROM format WHERE type = 'online'), 'Zoom: https://zoom.example/meet123'),
  ((SELECT id FROM format WHERE type = 'offline'), 'Auditorium 12');

-- –¢–∞–π–º-—Å–ª–æ—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è)
INSERT INTO time_slot (tutor_id, subject_id, location_id, start_dt, end_dt, capacity, status)
VALUES
(
  (SELECT tp.id FROM tutor_profiles tp
   JOIN "user" u ON tp.user_id = u.id
   WHERE u.email = 'petr@tutor.example'),
  (SELECT id FROM subjects WHERE name = 'Mathematics'),
  2, '2025-09-15 18:00', '2025-09-15 20:00', 2, 'published'
),
(
  (SELECT tp.id FROM tutor_profiles tp
   JOIN "user" u ON tp.user_id = u.id
   WHERE u.email = 'anna@tutor.example'),
  (SELECT id FROM subjects WHERE name = 'Physics'),
  1, '2025-09-16 17:00', '2025-09-16 19:00', 10, 'published'
);

-- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
INSERT INTO booking (slot_id, student_id, status)
VALUES
  (1, 2, 'booked');

-- –û—Ç–∑—ã–≤—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
INSERT INTO review (student_id, tutorsubject_id, booking_id, rating, comment)
VALUES
  (1, 1, 1, 5, '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–π —É—Ä–æ–∫, –º–∞—Ç–µ—Ä–∏–∞–ª —Ö–æ—Ä–æ—à–æ –æ–±—ä—è—Å–Ω–∏–ª–∏');
```
## PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

#### üîç –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç start_dt/end_dt –∫–∞–∫ TEXT)
```sql
CREATE OR REPLACE FUNCTION fn_get_available_slots(p_from timestamptz, p_to timestamptz)
RETURNS TABLE (
  slot_id INT,
  tutor_id INT,
  subject_id INT,
  start_dt TEXT,
  end_dt TEXT,
  capacity INT,
  booked_count INT,
  free_places INT
)
LANGUAGE sql
AS $$
  SELECT ts.id, ts.tutor_id, ts.subject_id, ts.start_dt, ts.end_dt, ts.capacity,
         COALESCE(bc.cnt, 0) AS booked_count,
         ts.capacity - COALESCE(bc.cnt, 0) AS free_places
  FROM time_slot ts
  LEFT JOIN (
    SELECT slot_id, count(*) AS cnt
    FROM booking
    WHERE (status IS NULL OR lower(status) = 'booked')
    GROUP BY slot_id
  ) bc ON bc.slot_id = ts.id
  WHERE (ts.start_dt::timestamptz) >= p_from
    AND (ts.start_dt::timestamptz) < p_to
    AND ts.capacity - COALESCE(bc.cnt, 0) > 0
  ORDER BY (ts.start_dt::timestamptz);
$$;
```
#### üìù –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
```sql
CREATE OR REPLACE FUNCTION fn_add_review(p_booking_id INT, p_rating INT, p_comment TEXT)
RETURNS INT
LANGUAGE plpgsql
AS $$
DECLARE
  v_booking RECORD;
  v_tutor_profile_id INT;
  v_new_id INT;
  v_cnt INT;
BEGIN
  -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  SELECT * INTO v_booking FROM booking WHERE id = p_booking_id LIMIT 1;
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Booking % not found', p_booking_id;
  END IF;

  -- –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤
  INSERT INTO review (student_id, tutorsubject_id, booking_id, rating, comment)
  VALUES (
    v_booking.student_id,
    NULL,
    p_booking_id,
    p_rating,
    p_comment
  )
  RETURNING id INTO v_new_id;

  -- –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å–ª–æ—Ç
  SELECT ts.tutor_id INTO v_tutor_profile_id
  FROM booking b
  JOIN time_slot ts ON b.slot_id = ts.id
  WHERE b.id = p_booking_id
  LIMIT 1;

  -- –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ —É —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
  IF v_tutor_profile_id IS NOT NULL THEN
    SELECT count(r.id) INTO v_cnt
    FROM review r
    JOIN booking b2 ON r.booking_id = b2.id
    JOIN time_slot ts2 ON b2.slot_id = ts2.id
    WHERE ts2.tutor_id = v_tutor_profile_id;

    UPDATE tutor_profiles
    SET rating_count = COALESCE(v_cnt, 0)
    WHERE id = v_tutor_profile_id;
  END IF;

  RETURN v_new_id;
END;
$$;
```

## ‚ö° –ò–Ω–¥–µ–∫—Å—ã
```sql
-- 1Ô∏è‚É£ –ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å: –±—ã—Å—Ç—Ä—ã–π –ø–æ–¥—Å—á—ë—Ç –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —Å–ª–æ—Ç–∞ (–∫–ª—é—á–µ–≤–æ–π –¥–ª—è –ø—Ä–µ—Ü–µ–¥–µ–Ω—Ç–∞ ID3)
CREATE INDEX IF NOT EXISTS idx_booking_slot_booked
  ON booking (slot_id)
  WHERE (status IS NULL OR lower(status) = 'booked');

-- 2Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞ (–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç)
CREATE INDEX IF NOT EXISTS idx_booking_student
  ON booking (student_id);

-- 3Ô∏è‚É£ –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–µ–≥–æ —Å–ª–æ—Ç–∞ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ (ORDER BY start_dt)
CREATE INDEX IF NOT EXISTS idx_time_slot_tutor_start_text
  ON time_slot (tutor_id, start_dt);

-- 4Ô∏è‚É£ –ü–æ–∏—Å–∫ —Å–ª–æ—Ç–æ–≤ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É –∏ –¥–∞—Ç–µ (—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ UI)
CREATE INDEX IF NOT EXISTS idx_time_slot_subject_start_text
  ON time_slot (subject_id, start_dt);

-- 5Ô∏è‚É£ –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö/–æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ (—É—Å–∫–æ—Ä—è–µ—Ç –≤—ã–¥–∞—á—É —Å–ø–∏—Å–∫–∞)
CREATE INDEX IF NOT EXISTS idx_time_slot_status_start_text
  ON time_slot (status, start_dt);
```

