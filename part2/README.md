# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—Å–∫–∏—Ö –∑–∞–Ω—è—Ç–∏–π

**–ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞, —ç—Ç–∞–ø ‚Ññ2**  
**–ê–≤—Ç–æ—Ä:** –°–∞–Ω–≥–∏–Ω–æ–≤ –ò–ª—ë—Å–¥–∂–æ–Ω

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∑–∞–¥–∞–Ω–∏—è)  
- [ER-–º–æ–¥–µ–ª—å](#ER-–º–æ–¥–µ–ª—å)  
- [–î–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å](#DDL-–º–æ–¥–µ–ª—å)  
- [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î PostgreSQL](#–†–µ–∞–ª–∏–∑–∞—Ü–∏—è-–¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π-–º–æ–¥–µ–ª–∏-–≤-—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π-–°–£–ë–î-PostgreSQL).
- [–¢—Ä–∏–≥–≥–µ—Ä—ã](#–¢—Ä–∏–≥–≥–µ—Ä—ã)  
- [–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è,—É–¥–∞–ª–µ–Ω–∏—è –ë–î,–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏](#–°–∫—Ä–∏–ø—Ç—ã-–¥–ª—è-—Å–æ–∑–¥–∞–Ω–∏—è-,-—É–¥–∞–ª–µ–Ω–∏—è-–ë–î-,-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è-–±–∞–∑—ã-—Ç–µ—Å—Ç–æ–≤—ã–º–∏-–¥–∞–Ω–Ω—ã–º–∏–µ)  
- [PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.](#PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏-–∏-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã-–¥–ª—è-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏-–≤–∞–∂–Ω—ã—Ö-–∑–∞–ø—Ä–æ—Å–æ–≤)  
- [–ò–Ω–¥–µ–∫—Å—ã](#–ò–Ω–¥–µ–∫—Å—ã)  

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è

1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å ER-–º–æ–¥–µ–ª—å (–≤ PDF/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏).  
2. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫—É—é –º–æ–¥–µ–ª—å (–º–∏–Ω–∏–º—É–º 10 —Å—É—â–Ω–æ—Å—Ç–µ–π, –µ—Å—Ç—å M:N).  
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –≤ PostgreSQL (DDL).  
4. –û–±–µ—Å–ø–µ—á–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å (DDL, —Ç—Ä–∏–≥–≥–µ—Ä—ã).  
5. –°–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ë–î –∏ seed.  
6. PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏/–ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.  
7. –°–æ–∑–¥–∞—Ç—å –∏ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã.

---

## ER-–º–æ–¥–µ–ª—å
<img alt=" " src="https://github.com/Ilyos2004/CourseWork/blob/dev2/part2/ER-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C.png">

## DDL-–º–æ–¥–µ–ª—å
<img alt=" " src="https://github.com/Ilyos2004/CourseWork/blob/dev2/part2/DDL%20-%20%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C.png">

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î PostgreSQL


```sql
-- 1. Role
CREATE TABLE roles (
  role_id SERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE
);

-- 2. User
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  full_name TEXT NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL,
  phone TEXT,
  role_id INT NOT NULL REFERENCES roles(role_id)
);

-- 3. Tutor_Profiles
CREATE TABLE tutor_profiles (
  id SERIAL PRIMARY KEY,
  experience_years INT DEFAULT 0 CHECK (experience_years >= 0),
  info TEXT,
  rating_count INT DEFAULT 0 CHECK (rating_count >= 0),
  languages TEXT,
  user_id INT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE
);

-- 4. Student_Profiles
CREATE TABLE student_profiles (
  id SERIAL PRIMARY KEY,
  preferred_language VARCHAR(100),
  goals TEXT,
  age INT,
  user_id INT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE
);

-- 5. Subjects
CREATE TABLE subjects (
  id SERIAL PRIMARY KEY,
  name VARCHAR(150) NOT NULL UNIQUE
);

-- 6. Tutor_Subjects
CREATE TABLE tutor_subjects (
  id SERIAL PRIMARY KEY,
  subject_id INT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  tutor_id INT NOT NULL REFERENCES tutor_profiles(id) ON DELETE CASCADE,
  info TEXT,
  count_students INT DEFAULT 0 CHECK (count_students >= 0),
  languages VARCHAR(150)
);

-- 7. Format
CREATE TABLE format (
  id SERIAL PRIMARY KEY,
  type TEXT NOT NULL UNIQUE
);

-- 8. Location
CREATE TABLE location (
  id SERIAL PRIMARY KEY,
  format_id INT REFERENCES format(id),
  info TEXT
);

-- 9. Time_Slot
CREATE TABLE time_slot (
  id SERIAL PRIMARY KEY,
  tutor_id INT NOT NULL REFERENCES tutor_profiles(id) ON DELETE CASCADE,
  subject_id INT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  location_id INT REFERENCES location(id),
  start_dt TEXT NOT NULL,
  end_dt TEXT NOT NULL,
  capacity INT NOT NULL DEFAULT 1 CHECK (capacity > 0),
  status TEXT
);

-- 10. Booking
CREATE TYPE booking_status AS ENUM ('booked', 'cancelled', 'completed');

CREATE TABLE booking (
  id SERIAL PRIMARY KEY,
  slot_id INT NOT NULL REFERENCES time_slot(id) ON DELETE CASCADE,
  student_id INT NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
  booked_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  status booking_status NOT NULL 
);

-- 11. Review
CREATE TABLE review (
  id SERIAL PRIMARY KEY,
  student_id INT NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
  tutorsubject_id INT REFERENCES tutor_subjects(id) ON DELETE SET NULL,
  rating INT CHECK (rating BETWEEN 1 AND 5),
  comment TEXT
);
```
## –¢—Ä–∏–≥–≥–µ—Ä—ã

#### 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –Ω–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –Ω–∞—á–∞–ª—Å—è

```sql
CREATE OR REPLACE FUNCTION check_booking_before_start()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  s timestamptz;
BEGIN
  -- –ø—Ä–∏–≤–æ–¥–∏–º TEXT -> timestamptz 
  SELECT start_dt::timestamptz INTO s
  FROM time_slot
  WHERE id = NEW.slot_id
  LIMIT 1;

  IF s IS NULL THEN
    RAISE EXCEPTION 'Slot % not found (booking before start check)', NEW.slot_id;
  END IF;

  IF s <= now() THEN
    RAISE EXCEPTION 'Cannot book slot %: it already started at %', NEW.slot_id, s;
  END IF;

  RETURN NEW;
END;
$$;
```
#### 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (capacity) –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –±—Ä–æ–Ω–∏
```sql
CREATE OR REPLACE FUNCTION fn_check_capacity()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  cap INT;
  cnt INT;
BEGIN
  -- –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å—á–∏—Ç–∞–µ—Ç—Å—è "booked"
  IF NOT (NEW.status IS NULL OR lower(NEW.status) = 'booked') THEN
    RETURN NEW;
  END IF;

  -- –µ—Å–ª–∏ —ç—Ç–æ UPDATE –∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ –±—ã–ª 'booked' ‚Äî –Ω–µ—Ç —Ä–æ—Å—Ç–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ -> –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
  IF TG_OP = 'UPDATE' AND (OLD.status IS NOT NULL AND lower(OLD.status) = 'booked') THEN
    RETURN NEW;
  END IF;

  -- –±–ª–æ–∫–∏—Ä—É–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É time_slot –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –ø–æ–¥—Å—á—ë—Ç–∞ –ø—Ä–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
  SELECT capacity INTO cap FROM time_slot WHERE id = NEW.slot_id FOR UPDATE;
  IF cap IS NULL THEN
    RAISE EXCEPTION 'Slot % not found (capacity check)', NEW.slot_id;
  END IF;

  -- –°—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç—ã—Ö –º–µ—Å—Ç
  SELECT count(*) INTO cnt FROM booking
    WHERE slot_id = NEW.slot_id AND (status IS NULL OR lower(status) = 'booked');

  --–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ª–∏–º–∏—Ç–æ–º
  IF cnt >= cap THEN
    RAISE EXCEPTION 'Cannot book slot %: capacity % already reached', NEW.slot_id, cap;
  END IF;
  
  RETURN NEW;
END;
$$;
```

#### 3Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–ª–æ—Ç–∞
```sql
-- –§—É–Ω–∫—Ü–∏—è: –∞–≤—Ç–æ-–æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ —Å–ª–æ—Ç–∞ –≤ status = 'cancelled'
CREATE OR REPLACE FUNCTION fn_auto_cancel_bookings_on_slot_cancel()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  IF TG_OP = 'UPDATE' AND OLD.status IS DISTINCT FROM NEW.status
     AND NEW.status IS NOT NULL AND lower(NEW.status) = 'cancelled' THEN

    UPDATE booking
    SET status = 'cancelled', updated_at = now()
    WHERE slot_id = NEW.id
      AND (status IS NULL OR lower(status) <> 'cancelled');
  END IF;

  RETURN NEW;
END;
$$;
```
## –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è –ë–î, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

#### üèóÔ∏è –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ë–î
```sql
CREATE DATABASE rehearsal_classes;
```
#### üóëÔ∏è–°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ë–î
```sql
DROP DATABASE rehearsal_classes;
```
#### –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
INSERT INTO roles (name) VALUES
  ('student'),
  ('tutor'),
  ('admin');

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
INSERT INTO "user" (full_name, email, password, phone, role_id)
VALUES
  ('Ivan Ivanov', 'ivan@student.example', 'pwd_hash_ivan', '+7-900-000-0001', 1),
  ('Petr Petrov', 'petr@tutor.example', 'pwd_hash_petr', '+7-900-000-0002', 1),
  ('Anna Annanovna', 'anna@tutor.example', 'pwd_hash_anna', '+7-900-000-0003', 2),
  ('Admin User', 'admin@example', 'pwd_hash_admin', '+7-900-000-0000', 3);

-- –ü—Ä–æ—Ñ–∏–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
INSERT INTO student_profiles (preferred_language, goals, age, user_id)
VALUES
  ('ru', '–ü–æ–≤—ã—Å–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ', 20, 2),
  ('ru', '–†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠', 17, 6);

-- –ü—Ä–µ–¥–º–µ—Ç—ã
INSERT INTO subjects (name) VALUES
  ('Mathematics'),
  ('Physics'),
  ('English');

-- –†–µ–ø–µ—Ç–∏—Ç–æ—Ä—ã –∏ –∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ã
INSERT INTO tutor_subjects (subject_id, tutor_id, info, count_students, languages)
VALUES
  (1, 1, '–ê–ª–≥–µ–±—Ä–∞, –∞–Ω–∞–ª–∏–∑, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠', 0, 'ru'),
  (2, 2, 'Physics, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ï–ì–≠', 15, 'ru,en');

-- –§–æ—Ä–º–∞—Ç—ã –∑–∞–Ω—è—Ç–∏–π
INSERT INTO format (type)
VALUES
  ('online'),
  ('offline');

-- –õ–æ–∫–∞—Ü–∏–∏
INSERT INTO location (format_id, info)
VALUES
  ((SELECT id FROM format WHERE type = 'online'), 'Zoom: https://zoom.example/meet123'),
  ((SELECT id FROM format WHERE type = 'offline'), 'Auditorium 12');

-- –¢–∞–π–º-—Å–ª–æ—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è)
INSERT INTO time_slot (tutor_id, subject_id, location_id, start_dt, end_dt, capacity, status)
VALUES
(
  (SELECT tp.id FROM tutor_profiles tp
   JOIN "user" u ON tp.user_id = u.id
   WHERE u.email = 'petr@tutor.example'),
  (SELECT id FROM subjects WHERE name = 'Mathematics'),
  2, '2025-09-15 18:00', '2025-09-15 20:00', 2, 'published'
),
(
  (SELECT tp.id FROM tutor_profiles tp
   JOIN "user" u ON tp.user_id = u.id
   WHERE u.email = 'anna@tutor.example'),
  (SELECT id FROM subjects WHERE name = 'Physics'),
  1, '2025-09-16 17:00', '2025-09-16 19:00', 10, 'published'
);

-- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
INSERT INTO booking (slot_id, student_id, status)
VALUES
  (1, 2, 'booked');

-- –û—Ç–∑—ã–≤—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
INSERT INTO review (student_id, tutorsubject_id, booking_id, rating, comment)
VALUES
  (1, 1, 1, 5, '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–∏–π —É—Ä–æ–∫, –º–∞—Ç–µ—Ä–∏–∞–ª —Ö–æ—Ä–æ—à–æ –æ–±—ä—è—Å–Ω–∏–ª–∏');
```
## PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

#### üîç –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç start_dt/end_dt –∫–∞–∫ TEXT)
```sql
CREATE OR REPLACE FUNCTION fn_get_available_slots(p_from timestamptz, p_to timestamptz)
-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
RETURNS TABLE (
  slot_id INT,
  tutor_id INT,
  subject_id INT,
  start_dt TEXT,
  end_dt TEXT,
  capacity INT,
  booked_count INT,
  free_places INT
)
LANGUAGE sql
AS $$
  SELECT ts.id, ts.tutor_id, ts.subject_id, ts.start_dt, ts.end_dt, ts.capacity,
         COALESCE(bc.cnt, 0) AS booked_count,
         ts.capacity - COALESCE(bc.cnt, 0) AS free_places
  FROM time_slot ts
  LEFT JOIN (
    SELECT slot_id, count(*) AS cnt
    FROM booking
    WHERE (status IS NULL OR lower(status) = 'booked')
    GROUP BY slot_id
  ) bc ON bc.slot_id = ts.id
  WHERE (ts.start_dt::timestamptz) >= p_from
    AND (ts.start_dt::timestamptz) < p_to
    AND ts.capacity - COALESCE(bc.cnt, 0) > 0
  ORDER BY (ts.start_dt::timestamptz);
$$;
```
#### üìù –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
```sql
CREATE OR REPLACE FUNCTION fn_add_review(p_booking_id INT, p_rating INT, p_comment TEXT)
RETURNS INT
LANGUAGE plpgsql
AS $$
-- –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DECLARE
  v_booking RECORD;              
  v_tutor_profile_id INT;       
  v_new_id INT;                  
  v_cnt INT;                     
  v_avg NUMERIC;                 
BEGIN
  -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏
  SELECT * INTO v_booking FROM booking WHERE id = p_booking_id LIMIT 1;
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Booking % not found', p_booking_id;
  END IF;

  -- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ 
  IF p_rating IS NULL OR p_rating < 1 OR p_rating > 5 THEN
    RAISE EXCEPTION 'Rating must be between 1 and 5 (got: %)', p_rating;
  END IF;
  --  –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ–±—ã —Ä–µ–π—Ç–∏–Ω–≥ –±—ã–ª –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1..5

  -- –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ—Ç–∑—ã–≤ 
  INSERT INTO review (student_id, tutorsubject_id, booking_id, rating, comment, created_at)
  VALUES (
    v_booking.student_id,     -- –±–µ—Ä–µ–º id —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –±—Ä–æ–Ω–∏
    tutorsubject_id,          -- –±–µ—Ä–µ–º id –ø—Ä–µ–¥–º–µ—Ç–∞ 
    p_booking_id,             -- —Å–≤—è–∑—ã–≤–∞–µ–º –æ—Ç–∑—ã–≤ —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    p_rating,                 -- –æ—Ü–µ–Ω–∫–∞
    p_comment,                -- –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    now()                     -- –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è
  )
  RETURNING id INTO v_new_id;
  -- —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç id —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏,

  -- –ù–∞—Ö–æ–¥–∏–º id –ø—Ä–æ—Ñ–∏–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ —Å–ª–æ—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  SELECT ts.tutor_id INTO v_tutor_profile_id
  FROM booking b
  JOIN time_slot ts ON b.slot_id = ts.id
  WHERE b.id = p_booking_id
  LIMIT 1;


  -- –ü–µ—Ä–µ—Å—á—ë—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
  IF v_tutor_profile_id IS NOT NULL THEN
    SELECT COUNT(r.id), AVG(r.rating)::numeric(3,2)
      INTO v_cnt, v_avg
    FROM review r
    JOIN booking b2 ON r.booking_id = b2.id
    JOIN time_slot ts2 ON b2.slot_id = ts2.id
    WHERE ts2.tutor_id = v_tutor_profile_id
      AND r.rating IS NOT NULL;

    -- –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –∏ —Å—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ 
    UPDATE tutor_profiles
    SET rating_count = v_cnt,
        rating_avg = ROUND(v_avg:),
        updated_at = now()
    WHERE id = v_tutor_profile_id;
  END IF;

  RETURN v_new_id;
END;
$$;

```

## ‚ö° –ò–Ω–¥–µ–∫—Å—ã
```sql
-- 1Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–ª–æ—Ç–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º tutor_id –∏ start_dt.
CREATE INDEX IF NOT EXISTS idx_time_slot_tutor_start ON time_slot(tutor_id, start_dt);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É (tutor_id) + –¥–∏–∞–ø–∞–∑–æ–Ω/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (start_dt) ‚Äî  –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å –¥–ª—è B-tree, –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–¥—Ç–∏ –ø–æ –∏–Ω–¥–µ–∫—Å—É –±–µ–∑ –ª–∏—à–Ω–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.


-- 2Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞.
CREATE INDEX IF NOT EXISTS idx_booking_student
  ON booking (student_id);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —á–∞—Å—Ç—ã–µ –≤—ã–±–æ—Ä–∫–∏ –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É (student_id = ‚Ä¶); B-tree –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π Index Scan/Only Scan.

-- 3Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤—ã–±–æ—Ä–∫—É –æ—Ç–∑—ã–≤–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±—Ä–æ–Ω—å—é. 
CREATE INDEX IF NOT EXISTS idx_review_booking ON review(booking_id);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Ç–æ—á–µ—á–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É (booking_id) ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è B-tree.

-- 4Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ —Å–ª–æ—Ç–æ–≤ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –¥–∞—Ç
–∏ –≤—ã–¥–∞—á–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞.
CREATE INDEX IF NOT EXISTS idx_time_slot_subject_start
  ON time_slot (subject_id, start_dt);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ subject_id + –¥–∏–∞–ø–∞–∑–æ–Ω/ORDER BY –ø–æ start_dt - B-tree —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –∏ —á—Ç–µ–Ω–∏–µ –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.


-- 5Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ —Å–ª–æ—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É (published/cancelled/draft)
--     –∏ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞.
CREATE INDEX IF NOT EXISTS idx_time_slot_status_start
  ON time_slot (status, start_dt);
  –¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É —Å—Ç–∞—Ç—É—Å–∞ –∏ –≤—ã–±–æ—Ä–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏; —Å–æ—Å—Ç–∞–≤–Ω–æ–π B-tree —É—Å–∫–æ—Ä—è–µ—Ç –ª—é–±—ã–µ —Å—Ç–∞—Ç—É—Å—ã (published/cancelled/draft) –∏ —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.

```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ 

#### 1) –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
```
 EXPLAIN ANALYZE
SELECT id, start_dt
FROM time_slot
WHERE tutor_id = (
  SELECT tp.id FROM tutor_profiles tp
  JOIN users u ON u.id = tp.user_id
  WHERE u.email = 'alice.tutor@example.com'
)
  AND start_dt >= to_char(now(), 'YYYY-MM-DD"T"HH24:MI:SSOF')
ORDER BY start_dt;

 Planning Time: 0.884 ms
 Execution Time: 0.152 ms
```
 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
 EXPLAIN ANALYZE
SELECT id, start_dt
FROM time_slot
WHERE tutor_id = (
        SELECT tp.id
        FROM tutor_profiles tp
        JOIN users u ON u.id = tp.user_id
        WHERE u.email = 'alice.tutor@example.com'
      )
  AND start_dt >= to_char(now(), 'YYYY-MM-DD"T"HH24:MI:SSOF')
ORDER BY start_dt;

 Planning Time: 0.538 ms
 Execution Time: 0.128 ms
```

#### 2) –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, slot_id, status, booked_at
FROM booking
WHERE student_id = (
  SELECT sp.id
  FROM student_profiles sp
  JOIN users u ON u.id = sp.user_id
  WHERE u.email = 'dave.student@example.com'  -- –ø–æ–¥—Å—Ç–∞–≤—å –Ω—É–∂–Ω—ã–π e-mail —Å—Ç—É–¥–µ–Ω—Ç–∞
)
ORDER BY booked_at DESC;

 Planning Time: 0.514 ms
 Execution Time: 0.118 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, slot_id, status, booked_at
FROM booking
WHERE student_id = (
  SELECT sp.id
  FROM student_profiles sp
  JOIN users u ON u.id = sp.user_id
  WHERE u.email = 'dave.student@example.com'
)
ORDER BY booked_at DESC;

 Planning Time: 0.538 ms
 Execution Time: 0.109 ms
```

 #### 3) –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, rating, comment
FROM review
WHERE booking_id = (SELECT id FROM booking ORDER BY id LIMIT 1);

 Planning Time: 0.349 ms
 Execution Time: 0.064 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, rating, comment
FROM review
WHERE booking_id = (SELECT id FROM booking ORDER BY id LIMIT 1);
```
 Planning Time: 0.328 ms

 Execution Time: 0.047 ms

 #### 4) –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, start_dt
FROM time_slot
WHERE subject_id = (SELECT id FROM subjects WHERE name = 'Math')
  AND start_dt >= '2025-11-01T00:00:00+00'
  AND start_dt <  '2025-12-01T00:00:00+00'
ORDER BY start_dt;

 Planning Time: 0.458 ms
 Execution Time: 0.104 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, start_dt
FROM time_slot
WHERE subject_id = (SELECT id FROM subjects WHERE name = 'Math')
  AND start_dt >= '2025-11-01T00:00:00+00'
  AND start_dt <  '2025-12-01T00:00:00+00'
ORDER BY start_dt;


 Planning Time: 0.382 ms
 Execution Time: 0.092 ms
```

 #### 5) –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, subject_id, start_dt
FROM time_slot
WHERE status = 'published'
  AND start_dt >= to_char(now(), 'YYYY-MM-DD"T"HH24:MI:SSOF')
ORDER BY start_dt;

 Planning Time: 0.381 ms
 Execution Time: 0.062 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, subject_id, start_dt
FROM time_slot
WHERE status = 'published'
  AND start_dt >= to_char(now(), 'YYYY-MM-DD"T"HH24:MI:SSOF')
ORDER BY start_dt;

 Planning Time: 0.378 ms
 Execution Time: 0.051 ms
```
