# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä—Å–∫–∏—Ö –∑–∞–Ω—è—Ç–∏–π

**–ö—É—Ä—Å–æ–≤–∞—è —Ä–∞–±–æ—Ç–∞, —ç—Ç–∞–ø ‚Ññ2**  
**–ê–≤—Ç–æ—Ä:** –°–∞–Ω–≥–∏–Ω–æ–≤ –ò–ª—ë—Å–¥–∂–æ–Ω

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-–∑–∞–¥–∞–Ω–∏—è)  
- [ER-–º–æ–¥–µ–ª—å](#ER-–º–æ–¥–µ–ª—å)  
- [–î–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å](#DDL-–º–æ–¥–µ–ª—å)  
- [–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î PostgreSQL](#–†–µ–∞–ª–∏–∑–∞—Ü–∏—è-–¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π-–º–æ–¥–µ–ª–∏-–≤-—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π-–°–£–ë–î-PostgreSQL).
- [–¢—Ä–∏–≥–≥–µ—Ä—ã](#–¢—Ä–∏–≥–≥–µ—Ä—ã)  
- [–°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è,—É–¥–∞–ª–µ–Ω–∏—è –ë–î,–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏](#–°–∫—Ä–∏–ø—Ç—ã-–¥–ª—è-—Å–æ–∑–¥–∞–Ω–∏—è-,-—É–¥–∞–ª–µ–Ω–∏—è-–ë–î-,-–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è-–±–∞–∑—ã-—Ç–µ—Å—Ç–æ–≤—ã–º–∏-–¥–∞–Ω–Ω—ã–º–∏–µ)  
- [PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.](#PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏-–∏-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã-–¥–ª—è-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏-–≤–∞–∂–Ω—ã—Ö-–∑–∞–ø—Ä–æ—Å–æ–≤)  
- [–ò–Ω–¥–µ–∫—Å—ã](#–ò–Ω–¥–µ–∫—Å—ã)  

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è

1. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å ER-–º–æ–¥–µ–ª—å (–≤ PDF/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏).  
2. –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫—É—é –º–æ–¥–µ–ª—å (–º–∏–Ω–∏–º—É–º 10 —Å—É—â–Ω–æ—Å—Ç–µ–π, –µ—Å—Ç—å M:N).  
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å –≤ PostgreSQL (DDL).  
4. –û–±–µ—Å–ø–µ—á–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å (DDL, —Ç—Ä–∏–≥–≥–µ—Ä—ã).  
5. –°–∫—Ä–∏–ø—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –ë–î –∏ seed.  
6. PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏/–ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.  
7. –°–æ–∑–¥–∞—Ç—å –∏ –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã.

---

## ER-–º–æ–¥–µ–ª—å
<img alt=" " src="https://github.com/Ilyos2004/CourseWork/blob/dev2/part2/ER-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C.png">

## DDL-–º–æ–¥–µ–ª—å
<img alt=" " src="https://github.com/Ilyos2004/CourseWork/blob/dev2/part2/DDL%20-%20%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C.png">

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç–∞–ª–æ–≥–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î PostgreSQL


```sql
-- 1. Role
CREATE TABLE roles (
  role_id SERIAL PRIMARY KEY,
  full_name TEXT NOT NULL UNIQUE
);

-- 2. User
CREATE TABLE IF NOT EXISTS users (
  id        SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  email     VARCHAR(100) NOT NULL UNIQUE,
  password  VARCHAR(255) NOT NULL,
  phone     TEXT,
  role_id   INT NOT NULL REFERENCES roles(role_id)
);

-- 3. Tutor_Profiles
CREATE TABLE tutor_profiles (
  id               SERIAL PRIMARY KEY,
  experience_years INT  DEFAULT 0 CHECK (experience_years >= 0),
  info             TEXT,
  rating_count     INT  DEFAULT 0 CHECK (rating_count >= 0),
  languages        TEXT,
  user_id          INT  NOT NULL REFERENCES users(id)
);

-- 4. Student_Profiles
CREATE TABLE student_profiles (
  id                 SERIAL PRIMARY KEY,
  preferred_language VARCHAR(100),
  goals              TEXT,
  age                INT,
  user_id            INT NOT NULL REFERENCES users(id)
);


-- 5. Subjects
CREATE TABLE subjects (
  id   SERIAL PRIMARY KEY,
  name VARCHAR(150) NOT NULL UNIQUE
);

-- 6. Tutor_Subjects
CREATE TABLE tutor_subjects (
  id             SERIAL PRIMARY KEY,
  subject_id     INT NOT NULL REFERENCES subjects(id),
  tutor_id       INT NOT NULL REFERENCES tutor_profiles(id),
  info           TEXT,
  count_students INT DEFAULT 0 CHECK (count_students >= 0),
  languages      VARCHAR(150)
);


-- 7. Format
CREATE TABLE format (
  id   SERIAL PRIMARY KEY,
  type TEXT NOT NULL UNIQUE
);

-- 8. Location
CREATE TABLE location (
  id        SERIAL PRIMARY KEY,
  format_id INT REFERENCES format(id),
  info      TEXT
);

-- 9. Time_Slot
CREATE TABLE time_slot (
  id          SERIAL PRIMARY KEY,
  tutor_id    INT  NOT NULL REFERENCES tutor_profiles(id),
  subject_id  INT  NOT NULL REFERENCES subjects(id),
  location_id INT  REFERENCES location(id),
  start_dt    TIMESTAMPTZ NOT NULL,
  end_dt      TIMESTAMPTZ NOT NULL,
  capacity    INT  NOT NULL DEFAULT 1 CHECK (capacity > 0),
  status      TEXT
);

-- 10. Booking
CREATE TYPE booking_status AS ENUM ('booked', 'cancelled', 'completed');

CREATE TABLE booking (
  id         SERIAL PRIMARY KEY,
  slot_id    INT NOT NULL REFERENCES time_slot(id),
  student_id INT NOT NULL REFERENCES student_profiles(id),
  booked_at  TIMESTAMPTZ NOT NULL DEFAULT now()
  status booking_status NOT NULL 
);

-- 11. Review
CREATE TABLE review (
  id              SERIAL PRIMARY KEY,
  student_id      INT NOT NULL REFERENCES student_profiles(id),
  tutorsubject_id INT REFERENCES tutor_subjects(id),
  rating          INT CHECK (rating BETWEEN 1 AND 5),
  comment         TEXT,
  booking_id      INT REFERENCES booking(id)
);
```
## –¢—Ä–∏–≥–≥–µ—Ä—ã

#### 1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ ‚Äî –Ω–µ–ª—å–∑—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –Ω–∞—á–∞–ª—Å—è

```sql
CREATE OR REPLACE FUNCTION check_booking_before_start()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  s timestamptz;
BEGIN
  -- –ø—Ä–∏–≤–æ–¥–∏–º TEXT -> timestamptz 
  SELECT start_dt INTO s
  FROM time_slot
  WHERE id = NEW.slot_id;

  IF s IS NULL THEN
    RAISE EXCEPTION 'Slot % not found (booking before start check)', NEW.slot_id;
  END IF;

  IF s <= now() THEN
    RAISE EXCEPTION 'Cannot book slot %: it already started at %', NEW.slot_id, s;
  END IF;

  RETURN NEW;
END;
$$;

-- –ø–æ–≤–µ—Å–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–∞–±–ª–∏—Ü—É
CREATE TRIGGER trg_booking_before_start
BEFORE INSERT OR UPDATE OF slot_id
ON booking
FOR EACH ROW
EXECUTE FUNCTION check_booking_before_start();

–ü—Ä–∏–º–µ—Ä—ã
select * from time_slot;

1)INSERT INTO booking(slot_id, student_id, status)
VALUES (5, 2, 'booked');

2)INSERT INTO booking(slot_id, student_id, status)
VALUES ( 8, 3,'booked');

-- –£–¥–∞–ª–∏—Ç—å
DROP FUNCTION IF EXISTS check_booking_before_start();

```
#### 2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (capacity) –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –±—Ä–æ–Ω–∏
```sql
CREATE OR REPLACE FUNCTION fn_check_capacity()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  cap INT;
  cnt INT;
BEGIN
  -- –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∏–ª–∏ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "booked"
  IF NOT (NEW.status IS NULL OR lower(NEW.status) = 'booked') THEN
    RETURN NEW;
  END IF;

  -- –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è (—É–∂–µ –±—ã–ª 'booked')
  IF TG_OP = 'UPDATE' AND (OLD.status IS NOT NULL AND lower(OLD.status) = 'booked') THEN
    RETURN NEW;
  END IF;

  -- –±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å–ª–æ—Ç–∞ (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–∫–∏ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—Å—Ç–∞–≤–∫–∞—Ö)
  SELECT capacity INTO cap FROM time_slot WHERE id = NEW.slot_id FOR UPDATE;
  IF cap IS NULL THEN
    RAISE EXCEPTION 'Slot % not found (capacity check)', NEW.slot_id;
  END IF;

  -- —Å—á–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–µ–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'booked'
  SELECT count(*) INTO cnt
  FROM booking
  WHERE slot_id = NEW.slot_id AND (status IS NULL OR lower(status) = 'booked');

  -- —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å –ª–∏–º–∏—Ç–æ–º
  IF cnt >= cap THEN
    RAISE EXCEPTION 'Cannot book slot %: capacity % already reached', NEW.slot_id, cap;
  END IF;

  RETURN NEW;
END;
$$;

--–ø–æ–≤–µ—Å–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–∞–±–ª–∏—Ü—É
CREATE TRIGGER trg_booking_capacity
BEFORE INSERT OR UPDATE OF slot_id, status
ON booking
FOR EACH ROW
EXECUTE FUNCTION fn_check_capacity();

-- –ü—Ä–∏–º–µ—Ä—ã
–°–∫–æ–ª—å–∫–æ –º–µ—Å—Ç —É–∂–µ –∑–∞–Ω—è—Ç–æ –≤ —Å–ª–æ—Ç–µ 1
SELECT COUNT(*) AS booked_cnt
FROM booking
WHERE slot_id = 1 AND (status IS NULL OR lower(status)='booked');


INSERT INTO booking(slot_id, student_id, status)
VALUES
(1, 1, 'booked');

-- –£–¥–∞–ª–∏—Ç—å
DROP FUNCTION IF EXISTS fn_check_capacity();

```

#### 3Ô∏è‚É£ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ —Å–ª–æ—Ç–∞
```sql
-- –§—É–Ω–∫—Ü–∏—è: –∞–≤—Ç–æ-–æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ —Å–ª–æ—Ç–∞ –≤ status = 'cancelled'
CREATE OR REPLACE FUNCTION fn_auto_cancel_bookings_on_slot_cancel()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  IF TG_OP = 'UPDATE'
     AND OLD.status IS DISTINCT FROM NEW.status
     AND NEW.status IS NOT NULL
     AND lower(NEW.status) = 'cancelled' THEN

    UPDATE booking
    SET status = 'cancelled',
        updated_at = now()
    WHERE slot_id = NEW.id
      AND (status IS NULL OR lower(status) <> 'cancelled');
  END IF;

  RETURN NEW;
END;
$$;

-- —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–∞–±–ª–∏—Ü—É time_slot
CREATE TRIGGER trg_slot_auto_cancel
AFTER UPDATE OF status
ON time_slot
FOR EACH ROW
EXECUTE FUNCTION fn_auto_cancel_bookings_on_slot_cancel();

–ü—Ä–∏–º–µ—Ä
-- –ø–æ–¥—Å—Ç–∞–≤—å id —Å–ª–æ—Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –±—Ä–æ–Ω–∏
SELECT slot_id, id AS booking_id, status
FROM booking
WHERE slot_id = 1    
ORDER BY id;

–û—Ç–º–µ–Ω–∏—Ç—å —Å–ª–æ—Ç
UPDATE time_slot
SET status = 'cancelled'
WHERE id = 1;

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±—Ä–æ–Ω–∏ —Ç–æ–∂–µ –æ—Ç–º–µ–Ω–∏–ª–∏—Å—å
SELECT slot_id, id AS booking_id, status
FROM booking
WHERE slot_id = 1
ORDER BY id;

-- –£–¥–∞–ª–∏—Ç—å
DROP FUNCTION IF EXISTS fn_auto_cancel_bookings_on_slot_cancel();

```


## –°–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è, —É–¥–∞–ª–µ–Ω–∏—è –ë–î, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

#### üèóÔ∏è –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ë–î
```sql
CREATE DATABASE rehearsal_classes;
```
#### üóëÔ∏è–°–∫—Ä–∏–ø—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ë–î
```sql
DROP DATABASE rehearsal_classes;
```
#### –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π
INSERT INTO roles(name) VALUES
  ('admin'), ('tutor'), ('student');

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
INSERT INTO users(full_name, email, password, phone, role_id) VALUES
  ('Alice',  'alice.tutor@example.com',  'hash', '+9924567895', (SELECT role_id FROM roles WHERE name='tutor')),
  ('Bob',    'bob.tutor@example.com',    'hash', '+9924567235', (SELECT role_id FROM roles WHERE name='tutor')),
  ('Carol',  'carol.tutor@example.com',  'hash', '+9924560487', (SELECT role_id FROM roles WHERE name='tutor')),
  ('Dave',   'dave.student@example.com', 'hash', '+9924564422', (SELECT role_id FROM roles WHERE name='student')),
  ('Eva',    'eva.student@example.com',  'hash', '+9924567332', (SELECT role_id FROM roles WHERE name='student')),
  ('Fred',   'fred.student@example.com', 'hash', '+9924560998', (SELECT role_id FROM roles WHERE name='student')),
  ('Olivia', 'olivia.tutor@example.com', 'hash', '+9924500101', (SELECT role_id FROM roles WHERE name='tutor')),
  ('Peter',  'peter.tutor@example.com',  'hash', '+9924500102', (SELECT role_id FROM roles WHERE name='tutor')),
  ('Quinn',  'quinn.tutor@example.com',  'hash', '+9924500103', (SELECT role_id FROM roles WHERE name='tutor')),
  ('Sara',   'sara.student@example.com', 'hash', '+9924500104', (SELECT role_id FROM roles WHERE name='student')),
  ('Tom',    'tom.student@example.com',  'hash', '+9924500105', (SELECT role_id FROM roles WHERE name='student')),
  ('Uma',    'uma.student@example.com',  'hash', '+9924500106', (SELECT role_id FROM roles WHERE name='student'));

-- 3) –ü—Ä–æ—Ñ–∏–ª–∏ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤ 
INSERT INTO tutor_profiles(user_id, experience_years, info, rating_count, languages) VALUES
  ((SELECT id FROM users WHERE email='alice.tutor@example.com'), 5, 'Experienced tutor', 0, 'en,ru'),
  ((SELECT id FROM users WHERE email='bob.tutor@example.com'),   3, 'STEM focus',        0, 'en'),
  ((SELECT id FROM users WHERE email='carol.tutor@example.com'), 7, 'IELTS/TOEFL',       0, 'en'),
  ((SELECT id FROM users WHERE email='olivia.tutor@example.com'),4, 'STEM tutor',        0, 'en'),
  ((SELECT id FROM users WHERE email='peter.tutor@example.com'), 6, 'Physics & lab',     0, 'en'),
  ((SELECT id FROM users WHERE email='quinn.tutor@example.com'), 2, 'English speaking',  0, 'en,ru');

-- –ü—Ä–æ—Ñ–∏–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
INSERT INTO student_profiles(user_id, preferred_language, goals, age) VALUES
  ((SELECT id FROM users WHERE email='dave.student@example.com'), 'en', 'Improve math skills', 21),
  ((SELECT id FROM users WHERE email='eva.student@example.com'),  'en', 'Exam prep',           20),
  ((SELECT id FROM users WHERE email='fred.student@example.com'), 'en', 'Conversation',        22),
  ((SELECT id FROM users WHERE email='sara.student@example.com'), 'en', 'Catch up in math',    19),
  ((SELECT id FROM users WHERE email='tom.student@example.com'),  'en', 'Physics practice',    20),
  ((SELECT id FROM users WHERE email='uma.student@example.com'),  'en', 'Improve speaking',    21);


-- –ü—Ä–µ–¥–º–µ—Ç—ã
INSERT INTO subjects(name) VALUES
  ('Math'), ('Physics'), ('English');

-- –†–µ–ø–µ—Ç–∏—Ç–æ—Ä—ã –∏ –∏—Ö –ø—Ä–µ–¥–º–µ—Ç—ã
INSERT INTO tutor_subjects(subject_id, tutor_id, info, count_students, languages) VALUES
  ((SELECT id FROM subjects WHERE name='Math'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='alice.tutor@example.com')),
   'Teaches with practice', 0, 'en'),
  ((SELECT id FROM subjects WHERE name='English'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='alice.tutor@example.com')),
   'Speaking club', 0, 'en'),
  ((SELECT id FROM subjects WHERE name='Physics'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='bob.tutor@example.com')),
   'Problem solving', 0, 'en'),
  ((SELECT id FROM subjects WHERE name='English'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='carol.tutor@example.com')),
   'Exam focus', 0, 'en'),
  ((SELECT id FROM subjects WHERE name='Math'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='olivia.tutor@example.com')),
   'Algebra & practice', 0, 'en'),
  ((SELECT id FROM subjects WHERE name='Physics'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='peter.tutor@example.com')),
   'Mechanics basics', 0, 'en'),
  ((SELECT id FROM subjects WHERE name='English'),
   (SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='quinn.tutor@example.com')),
   'Speaking club', 0, 'en,ru');

-- –§–æ—Ä–º–∞—Ç—ã –∑–∞–Ω—è—Ç–∏–π
INSERT INTO format(type) VALUES ('online'), ('offline');

-- –õ–æ–∫–∞—Ü–∏–∏
INSERT INTO location(format_id, info) VALUES
  ((SELECT id FROM format WHERE type='online'),  'Zoom'),
  ((SELECT id FROM format WHERE type='offline'), 'Campus Room 101');

-- –¢–∞–π–º-—Å–ª–æ—Ç—ã (–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è)
INSERT INTO time_slot(tutor_id, subject_id, location_id, start_dt, end_dt, capacity, status) VALUES
  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='alice.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='Math'),
   (SELECT id FROM location WHERE info='Zoom'),
   '2025-11-12T09:00:00+00'::timestamptz, '2025-11-12T10:00:00+00'::timestamptz, 3, 'published'),

  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='alice.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='Math'),
   (SELECT id FROM location WHERE info='Zoom'),
   '2025-11-13T11:00:00+00'::timestamptz, '2025-11-13T12:00:00+00'::timestamptz, 2, 'draft'),

  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='bob.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='Physics'),
   (SELECT id FROM location WHERE info='Campus Room 101'),
   '2025-11-12T14:00:00+00'::timestamptz, '2025-11-12T15:30:00+00'::timestamptz, 2, 'published'),

  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='carol.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='English'),
   (SELECT id FROM location WHERE info='Zoom'),
   '2025-11-14T08:30:00+00'::timestamptz, '2025-11-14T09:30:00+00'::timestamptz, 1, 'published'),

  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='olivia.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='Math'),
   (SELECT id FROM location WHERE info='Zoom'),
   '2025-11-25T10:00:00+00'::timestamptz, '2025-11-25T11:00:00+00'::timestamptz, 3, 'published'),

  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='peter.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='Physics'),
   (SELECT id FROM location WHERE info='Campus Room 101'),
   '2025-11-26T12:00:00+00'::timestamptz, '2025-11-26T13:30:00+00'::timestamptz, 2, 'published'),

  ((SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='quinn.tutor@example.com')),
   (SELECT id FROM subjects WHERE name='English'),
   (SELECT id FROM location WHERE info='Zoom'),
   '2025-11-27T15:00:00+00'::timestamptz, '2025-11-27T16:00:00+00'::timestamptz, 2, 'published');

-- –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
INSERT INTO booking(slot_id, student_id, status, booked_at) VALUES
  ((SELECT id FROM time_slot WHERE start_dt='2025-11-12T09:00:00+00'::timestamptz),
   (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='dave.student@example.com')),
   'booked', now() - interval '2 days'),

  ((SELECT id FROM time_slot WHERE start_dt='2025-11-12T14:00:00+00'::timestamptz),
   (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='eva.student@example.com')),
   'booked', now() - interval '1 day'),

  ((SELECT id FROM time_slot WHERE start_dt='2025-11-14T08:30:00+00'::timestamptz),
   (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='fred.student@example.com')),
   'cancelled', now()),

  ((SELECT id FROM time_slot WHERE start_dt='2025-11-25T10:00:00+00'::timestamptz),
   (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='sara.student@example.com')),
   'booked', now() - interval '3 hours'),

  ((SELECT id FROM time_slot WHERE start_dt='2025-11-26T12:00:00+00'::timestamptz),
   (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='tom.student@example.com')),
   'booked', now() - interval '2 hours'),

  ((SELECT id FROM time_slot WHERE start_dt='2025-11-27T15:00:00+00'::timestamptz),
   (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='uma.student@example.com')),
   'booked', now() - interval '1 hour');

-- –û—Ç–∑—ã–≤—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
INSERT INTO review(student_id, tutorsubject_id, rating, comment, booking_id) VALUES
  (
    (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='dave.student@example.com')),
    (SELECT id FROM tutor_subjects
       WHERE tutor_id=(SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='alice.tutor@example.com'))
         AND subject_id=(SELECT id FROM subjects WHERE name='Math')),
    5, 'Great session!',
    (SELECT id FROM booking
       WHERE slot_id=(SELECT id FROM time_slot WHERE start_dt='2025-11-12T09:00:00+00'::timestamptz)
         AND student_id=(SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='dave.student@example.com')))
  ),

  (
    (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='eva.student@example.com')),
    (SELECT id FROM tutor_subjects
       WHERE tutor_id=(SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='bob.tutor@example.com'))
         AND subject_id=(SELECT id FROM subjects WHERE name='Physics')),
    4, 'Very helpful',
    (SELECT id FROM booking
       WHERE slot_id=(SELECT id FROM time_slot WHERE start_dt='2025-11-12T14:00:00+00'::timestamptz)
         AND student_id=(SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='eva.student@example.com')))
  ),

  (
    (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='fred.student@example.com')),
    (SELECT id FROM tutor_subjects
       WHERE tutor_id=(SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='carol.tutor@example.com'))
         AND subject_id=(SELECT id FROM subjects WHERE name='English')),
    3, 'Good, but could be longer',
    (SELECT id FROM booking
       WHERE slot_id=(SELECT id FROM time_slot WHERE start_dt='2025-11-14T08:30:00+00'::timestamptz)
         AND student_id=(SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='fred.student@example.com')))
  ),

  (
    (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='sara.student@example.com')),
    (SELECT id FROM tutor_subjects
       WHERE tutor_id=(SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='olivia.tutor@example.com'))
         AND subject_id=(SELECT id FROM subjects WHERE name='Math')),
    5, 'Very helpful, thanks!',
    (SELECT id FROM booking
       WHERE slot_id=(SELECT id FROM time_slot WHERE start_dt='2025-11-25T10:00:00+00'::timestamptz)
         AND student_id=(SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='sara.student@example.com')))
  ),

  (
    (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='tom.student@example.com')),
    (SELECT id FROM tutor_subjects
       WHERE tutor_id=(SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='peter.tutor@example.com'))
         AND subject_id=(SELECT id FROM subjects WHERE name='Physics')),
    4, 'Good explanations',
    (SELECT id FROM booking
       WHERE slot_id=(SELECT id FROM time_slot WHERE start_dt='2025-11-26T12:00:00+00'::timestamptz)
         AND student_id=(SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='tom.student@example.com')))
  ),

  (
    (SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='uma.student@example.com')),
    (SELECT id FROM tutor_subjects
       WHERE tutor_id=(SELECT id FROM tutor_profiles WHERE user_id=(SELECT id FROM users WHERE email='quinn.tutor@example.com'))
         AND subject_id=(SELECT id FROM subjects WHERE name='English')),
    5, 'Great speaking practice!',
    (SELECT id FROM booking
       WHERE slot_id=(SELECT id FROM time_slot WHERE start_dt='2025-11-27T15:00:00+00'::timestamptz)
         AND student_id=(SELECT id FROM student_profiles WHERE user_id=(SELECT id FROM users WHERE email='uma.student@example.com')))
  );

```
## PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

#### üîç –ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç start_dt/end_dt –∫–∞–∫ TEXT)
```sql
CREATE OR REPLACE FUNCTION fn_get_available_slots(p_from timestamptz, p_to timestamptz)
-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏:
RETURNS TABLE (
  slot_id INT,
  tutor_id INT,
  subject_id INT,
  start_dt TEXT,
  end_dt TEXT,
  capacity INT,
  booked_count INT,
  free_places INT
)
LANGUAGE sql
AS $$
  SELECT
         ts.id,
         ts.tutor_id,
         ts.subject_id,
         ts.start_dt::text AS start_dt,
         ts.end_dt::text   AS end_dt,
         ts.capacity,
         COALESCE(bc.cnt, 0) AS booked_count,
         ts.capacity - COALESCE(bc.cnt, 0) AS free_places
  FROM time_slot ts
  LEFT JOIN (
    SELECT slot_id, count(*) AS cnt
    FROM booking
    WHERE (status IS NULL OR lower(status) = 'booked')
    GROUP BY slot_id
  ) bc ON bc.slot_id = ts.id
  WHERE ts.start_dt >= p_from
    AND ts.start_dt < p_to
    AND ts.capacity - COALESCE(bc.cnt, 0) > 0
  ORDER BY ts.start_dt;
$$;

–ü—Ä–∏–º–µ—Ä—ã
-- –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –∑–∞ –Ω–µ–¥–µ–ª—é
SELECT * FROM fn_get_available_slots('2025-11-20+00', '2025-11-28+00');

-- —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É Math
SELECT *
FROM fn_get_available_slots('2025-11-20+00','2025-11-28+00')
WHERE subject_id = (SELECT id FROM subjects WHERE name='Math');

-- –£–¥–∞–ª–∏—Ç—å
DROP FUNCTION IF EXISTS fn_get_available_slots(timestamptz, timestamptz);

```
#### üìù –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
```sql
CREATE OR REPLACE FUNCTION fn_add_review(p_booking_id INT, p_rating INT, p_comment TEXT)
RETURNS INT
LANGUAGE plpgsql
AS $$
-- –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
DECLARE
  v_booking RECORD;
  v_tutor_profile_id INT;
  v_tutor_subject_id INT;
  v_new_id INT;
  v_cnt INT;
  v_avg NUMERIC;
BEGIN
  -- –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏
  SELECT * INTO v_booking FROM booking WHERE id = p_booking_id LIMIT 1;
  IF NOT FOUND THEN
    RAISE EXCEPTION 'Booking % not found', p_booking_id;
  END IF;

  -- –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω —Ä–µ–π—Ç–∏–Ω–≥–∞
  IF p_rating IS NULL OR p_rating < 1 OR p_rating > 5 THEN
    RAISE EXCEPTION 'Rating must be between 1 and 5 (got: %)', p_rating;
  END IF;

  -- –ù–∞—Ö–æ–¥–∏–º ID –ø—Ä–æ—Ñ–∏–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ –∏ —Å–≤—è–∑–∫—É –ø—Ä–µ–¥–º–µ—Ç–∞
  SELECT ts.tutor_id, ts.subject_id INTO v_tutor_profile_id, v_tutor_subject_id
  FROM booking b
  JOIN time_slot ts ON b.slot_id = ts.id
  WHERE b.id = p_booking_id
  LIMIT 1;

  -- –í—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–∑—ã–≤
  INSERT INTO review (student_id, tutorsubject_id, booking_id, rating, comment, created_at)
  VALUES (
    v_booking.student_id,
    v_tutor_subject_id,
    p_booking_id,
    p_rating,
    p_comment,
    now()
  )
  RETURNING id INTO v_new_id;

  -- –ü–µ—Ä–µ—Å—á—ë—Ç —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
  IF v_tutor_profile_id IS NOT NULL THEN
    SELECT COUNT(r.id), AVG(r.rating)::numeric(3,2)
      INTO v_cnt, v_avg
    FROM review r
    JOIN booking b2 ON r.booking_id = b2.id
    JOIN time_slot ts2 ON b2.slot_id = ts2.id
    WHERE ts2.tutor_id = v_tutor_profile_id
      AND r.rating IS NOT NULL;

    -- –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞
    UPDATE tutor_profiles
    SET rating_count = v_cnt,
        info = CONCAT(info, ' | avg=', ROUND(v_avg, 2)),  -- –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—è rating_avg
        updated_at = now()
    WHERE id = v_tutor_profile_id;
  END IF;

  RETURN v_new_id;
END;
$$;

-- –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
SELECT fn_add_review(3, 5, '–û—Ç–ª–∏—á–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ!');
SELECT fn_add_review(4, 4, '–•–æ—Ä–æ—à–µ–µ –∑–∞–Ω—è—Ç–∏–µ!');

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
SELECT * FROM review ORDER BY id DESC;
SELECT id, rating_count, info FROM tutor_profiles;

-- –£–¥–∞–ª–∏—Ç—å
DROP FUNCTION IF EXISTS fn_add_review(integer, integer, text);

```

## ‚ö° –ò–Ω–¥–µ–∫—Å—ã
```sql
-- 1Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–ª–æ—Ç–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º tutor_id –∏ start_dt.
CREATE INDEX IF NOT EXISTS idx_time_slot_tutor_start ON time_slot(tutor_id, start_dt);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É (tutor_id) + –¥–∏–∞–ø–∞–∑–æ–Ω/—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (start_dt) ‚Äî  –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å –¥–ª—è B-tree, –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–¥—Ç–∏ –ø–æ –∏–Ω–¥–µ–∫—Å—É –±–µ–∑ –ª–∏—à–Ω–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.


-- 2Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞.
CREATE INDEX IF NOT EXISTS idx_booking_student
  ON booking (student_id);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —á–∞—Å—Ç—ã–µ –≤—ã–±–æ—Ä–∫–∏ –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É (student_id = ‚Ä¶); B-tree –¥–∞—ë—Ç –±—ã—Å—Ç—Ä—ã–π Index Scan/Only Scan.

-- 3Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤—ã–±–æ—Ä–∫—É –æ—Ç–∑—ã–≤–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±—Ä–æ–Ω—å—é. 
CREATE INDEX IF NOT EXISTS idx_review_booking ON review(booking_id);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Ç–æ—á–µ—á–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É (booking_id) ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è B-tree.

-- 4Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ —Å–ª–æ—Ç–æ–≤ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –¥–∞—Ç
–∏ –≤—ã–¥–∞—á–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞.
CREATE INDEX IF NOT EXISTS idx_time_slot_subject_start
  ON time_slot (subject_id, start_dt);
–¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ subject_id + –¥–∏–∞–ø–∞–∑–æ–Ω/ORDER BY –ø–æ start_dt - B-tree —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –∏ —á—Ç–µ–Ω–∏–µ –≤ –Ω—É–∂–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.


-- 5Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ —Å–ª–æ—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É (published/cancelled/draft)
--     –∏ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞.
CREATE INDEX IF NOT EXISTS idx_time_slot_status_start
  ON time_slot (status, start_dt);
  –¢–∏–ø: B-tree
-- –ü–æ—Ç–æ–º—É —á—Ç–æ, —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–∞–≤–µ–Ω—Å—Ç–≤—É —Å—Ç–∞—Ç—É—Å–∞ –∏ –≤—ã–±–æ—Ä–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏; —Å–æ—Å—Ç–∞–≤–Ω–æ–π B-tree —É—Å–∫–æ—Ä—è–µ—Ç –ª—é–±—ã–µ —Å—Ç–∞—Ç—É—Å—ã (published/cancelled/draft) –∏ —Å–Ω–∏–∂–∞–µ—Ç –≤—Ä–µ–º—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.

```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ 

#### 1Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö —Å–ª–æ—Ç–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º tutor_id –∏ start_dt. 
 ```
–î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:

EXPLAIN ANALYZE
SELECT id, start_dt
FROM time_slot
WHERE tutor_id = (
  SELECT tp.id
  FROM tutor_profiles tp
  JOIN users u ON u.id = tp.user_id
  WHERE u.email = 'alice.tutor@example.com'
)
AND start_dt >= now()
ORDER BY start_dt;

 Planning Time: 0.884 ms
 Execution Time: 0.186 ms
```
 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT ts.id, ts.start_dt
FROM time_slot ts
JOIN tutor_profiles tp ON tp.id = ts.tutor_id
JOIN users u ON u.id = tp.user_id
WHERE u.email = 'alice.tutor@example.com'
  AND ts.start_dt >= now()
ORDER BY ts.start_dt
LIMIT 20;

 Planning Time: 0.538 ms
 Execution Time: 0.128 ms
```

#### 2Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞.
```
–î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:

EXPLAIN (ANALYZE, BUFFERS)
SELECT id, slot_id, status, booked_at
FROM booking
WHERE student_id = (
  SELECT sp.id
  FROM student_profiles sp
  JOIN users u ON u.id = sp.user_id
  WHERE u.email = 'dave.student@example.com'  -- –ø–æ–¥—Å—Ç–∞–≤—å –Ω—É–∂–Ω—ã–π e-mail —Å—Ç—É–¥–µ–Ω—Ç–∞
)
ORDER BY booked_at DESC;

 Planning Time: 0.514 ms
 Execution Time: 0.118 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, slot_id, status, booked_at
FROM booking
WHERE student_id = (
  SELECT sp.id
  FROM student_profiles sp
  JOIN users u ON u.id = sp.user_id
  WHERE u.email = 'dave.student@example.com'
)
ORDER BY booked_at DESC;

 Planning Time: 0.538 ms
 Execution Time: 0.109 ms
```

 #### 3Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å —É—Å–∫–æ—Ä—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤—ã–±–æ—Ä–∫—É –æ—Ç–∑—ã–≤–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±—Ä–æ–Ω—å—é. 
```
 –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:

EXPLAIN (ANALYZE, BUFFERS)
SELECT id, rating, comment
FROM review
WHERE booking_id = 1;

 Planning Time: 0.349 ms
 Execution Time: 0.064 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, rating, comment
FROM review
WHERE booking_id = (SELECT id FROM booking ORDER BY id LIMIT 1);
```
 Planning Time: 0.328 ms

 Execution Time: 0.047 ms

 #### 4Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞ —Å–ª–æ—Ç–æ–≤ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ –¥–∞—Ç
 ```
 –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:

EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, start_dt
FROM time_slot
WHERE subject_id = (SELECT id FROM subjects WHERE name = 'Math')
  AND start_dt >= '2025-11-01T00:00:00+00'
  AND start_dt <  '2025-12-01T00:00:00+00'
ORDER BY start_dt;

 Planning Time: 0.458 ms
 Execution Time: 0.104 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, start_dt
FROM time_slot
WHERE subject_id = (SELECT id FROM subjects WHERE name = 'Math')
  AND start_dt >= '2025-11-01T00:00:00+00'
  AND start_dt <  '2025-12-01T00:00:00+00'
ORDER BY start_dt;


 Planning Time: 0.382 ms
 Execution Time: 0.092 ms
```

 #### 5Ô∏è‚É£ –ò–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ —Å–ª–æ—Ç–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å—É (published/cancelled/draft)
 –î–æ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, subject_id, start_dt
FROM time_slot
WHERE status = 'published'
  AND start_dt >= now()            
ORDER BY start_dt;

 Planning Time: 0.381 ms
 Execution Time: 0.062 ms
```

 #### –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞:
 ```
EXPLAIN (ANALYZE, BUFFERS)
SELECT id, tutor_id, subject_id, start_dt
FROM time_slot
WHERE status = 'published'
  AND start_dt >= now()            
ORDER BY start_dt;

 Planning Time: 0.378 ms
 Execution Time: 0.051 ms
```
